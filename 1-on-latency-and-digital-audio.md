# 一 延迟与数字音频详述
## 1 介绍
### 1.1 数字音频

人类感知声音是完全模拟的现象，即纵波在介质中的传播。这一现象由物理界进行描述，同时催生了声学的跨学科研究，其用于研究机械波的虚拟感知，以及声波使人类引起的听觉。

模拟音频有一个关键性质：它是个连续信号。这一点既适用于空气中的声波，也适用于转化成的电信号：每个时刻都有一个表示当前时刻信号的值，这个值可以是压强、电压和电流。

用数字表示的音频是不连续的。音频信号经过给定间隔的采样后转化为一串数字。和纯模拟的信号处理相反，数字音频使用时间离散的采样表示。

数字音频信号的最小粒度就是一个采样，采样率为每秒 48000 采样时对应 20 微秒。

虽然这种离散的信号转换回的模拟信号看似是离散的阶梯状信号，但实际并非如此。根据采样定理，当信号的带宽不高于采样率的一半时，模拟信号和离散的音频采样表示的数字信号之间的转化是唯一的。

虽然技术上选择高采样率是合理行为[10]，但可闻频段上界的二倍足够涵盖一般的音频制作用途。人耳最高的可闻频率在 20kHz 左右，这是由近一个世纪的实验数据支撑的论断值，因此采样率高于每秒 40000 采样（通常的采样率为 CD 的 44.1kHz，以及 DVD 的 48kHz）。

### 1.2 延迟和延迟补偿

模拟与数字信号互转的副作用之一在于，这一过程会消耗时间。

模拟到数字转换器（ADC）会以离散的间隔进行采样操作（如上文提到的 20 微秒）。采样值只有转换后才能得出。等到数字表示可用时，信号就已经传走了。类似的是，使用数字到模拟转换器（DAC）进行反向转换又会引入延迟。

与信号的纯模拟旁通相比，数字采样后重建的信号必然会有延迟。

将信号与自身经过延迟的信号叠加，会产生很多影响。（当信号是正弦波时，）如果两个信号的相位差为 180度时，二者会完全抵消，叠加结果为无声，如图 2 所示。这种效应的一般情况称作梳状滤波：一些频率会抵消（从而衰减），剩下的会增益。

如果两个信号间的延迟较大（或者存在 non-constant ratio），则会形成振幅调制，即可闻的 *beating*。更大的延迟则被感知为回声。经验法则如下：人类可以将 10ms 以上的延迟感知为两次~~事件~~（对应频率为 100Hz），不过这也因信号的类型和基频而异。经过专业训练的音乐家通常对时间对齐的准确性以及不同 time-scale 的时间波动更为敏感。感知上是否同时发生通常是主观的。对于音频/视频同步而言，时间对齐的容忍值稳定为 +25ms（音频更早）无法察觉，-100ms（音频更迟）能够察觉。

在制作音乐时，混合不同延迟的信号会导致负面影响。

如果延迟比人耳可闻频率的上限小得多，且信号的采样率足够高，则造成的影响可以忽略。很多高端的专业系统之所以使用专用的 DSP 电路实现，不用一般的计算机构建，正是因为纯硬件方案可以在不足毫秒的延迟下处理信号，以及响应时间短。然而，通用的计算机有着多用途的优点。专用硬件的用途通常受限，而通用的计算机更加灵活。

理论背景可追溯至上世纪 30 年代，但将数字音频用作音乐和作曲在上世纪 50 年代开始，不少艺术家在 60-70 年代用其进行实验。一般的音乐制作在 80 世纪初从模拟平台向数字平台迁移，但直到 90 年代主要的制作和后期处理的工作流才跟着进行迁移。

21 世纪初，计算机变得足够强大，实时处理音频也变得可行。数字音频工作站也脱离了专业的市场定位，使得一般用户可以使用这些工具进行作曲，录制和制作工作。

一般的个人电脑包含一系列组件，从音频接口、总线（PCI、USB）到 CPU 南桥。现代的计算机架构针对带宽优化，而非吞吐量。这一限制偏向于单次处理大块数据，而非一个采样[13]。尽管处理块状数据能减少总体的资源占用，优化总体性能，但这也会引入最小响应时间。

此过程引入的延迟虽然小，但是无法忽略。例如，（块大小为）64 采样，采样率为每秒 48000 采样，输入一块（block），输出一块（，则输入信号与输出信号的延迟为）  
2 * 64 / 48000 = 2.66(ms)  
要形成正确的认知，这一延迟是声波在空气中传播 90cm（从钢琴到演奏者人耳）花费的时间。

通用的，未经优化的个人电脑的延迟通常会更高，例如，微软 Windows 操作系统默认的调度粒度是每个时间片 16ms。

这一延迟的术语为响应延迟（latency）：

> 响应延迟是系统对给定刺激源的反应时长。

在音频领域的语境下，这一延迟通常分为输入延迟和输出延迟：
- 输入延迟：数字化的音频可用于数字处理的必要时长。通常为一个块的时长。
- 输出延迟：数字化的音频经过处理后传出处理链的必要时长。至少为一个块的时长。

这样的区分方式是实现细节的内容，起初并不重要。真正重要的是二者的结合。往返延迟（round-trip latency）是音频事件输入，处理和输出的必要时长。

需要指出的是，个人电脑的处理延迟有选择的余地，可以降低至由硬件（音频设备、CPU 和总线速度）决定的限制。延迟降低会加大计算机的负载，因为需要处理的音频所在的块更小，传入更频繁。延迟越低，系统就越有可能无法赶上处理的时限，导致 x-run 现象（缓冲区过载与缓冲区欠载的简称）的发生，从而使音频流中出现杂音。

低延迟并非只有好处，也有一些缺点：最突出的一点在于耗电变多，因为 CPU 需要处理更多小块的音频数据，一直处于活动状态，无法进入省电模式（考虑风扇声音）。此外，如果处理声音的应用程序不止一个，那么对于每个程序，每个音频循环都需要运行一小段给定时长，导致系统占用变高，x-run 的几率增大。

不过有些场合下，低延迟相当重要，因为需要电脑迅速响应：
- 演奏虚拟乐器：按下琴键到乐器发出声音的延迟过高，会影响大多数乐手的时间感知。
- 软件音频监听：歌手通过头骨传导和耳机听到自己的歌声，延迟过高会令人烦扰。
- 实时效果：这一场合和演奏虚拟乐器类似，不过这次与虚拟乐器或合成器无关，而是实际的乐器和效果处理。将计算机用作效果机架（如吉他效果器）时，低延迟很关键；另外，如果手动触发诸如延迟效果器（delay）之类的效果器，精确的同步也很重要。
- 实时混音：有些音频工程师会使用计算机进行现场表演的混音。这一场景基本是上述场景的结合：在台上进行监听、效果器处理以及均衡器。这一场景其实更为复杂，因为不仅要求低延迟（即音频不要显著滞后于表演），对于前后的扬声器而言，还要求延迟确定（尽可能减少时基抖动）。

其他多数场景下，如回放、录音、叠录、混音、母带处理等，延迟并不重要。此时延迟数据可以相对大一些，容易进行补偿。具体而言，进行混音和母带处理时，不管按下播放键到声音从扬声器发出的延迟是 10ms 还是 100ms，用户是不关心的。开节拍器和预备拍进行录音时同样如此。

然而，进行多轨操作（tracking）时，回访的声音和录制的声音对齐是很重要的。

这时延迟补偿开始发挥作用了。在数字音频工作站（DAW）中，进行延迟补偿有两种方式：
- 先读：DAW 提早进行回放，之后声音传到扬声器时便与要录制的内容对齐了。
- 后写：要达到相同效果，为传入的音频引入延迟，使其与播放的音频对齐。

### 1.3 信号链路

在进行音乐制作时，声音源会途径多个地方。这些地方既可以是对外可见的连接，例如音频工程师将麦克风接入前置放大器，再接混响效果器，也可以是效果器内部对外隐藏的连接，用户无法观测。对外可见的连接通常使用跳线板（patchbay）完成，这种设备允许将任意音频源连接到任意的目标位置。有些跳线板可以对信号进行组合，但叠加信号常用的办法是使用混音器，它可以控制各个信号的电平。其中一个重要的场景是编组操作：将若干关联的音频源组合至一条总线，以共享控制和效果器设定，例如，一个鼓总线将一套架子鼓的各个麦克风组合为一个立体声混音。

信号映射至总线并非一对一连接。例如，架子鼓的所有麦克风都能以特定电平合并到一条总线，从而进行通用的音量控制，同时有些麦克风（例如吊镲的麦克风）可以同时接另一条总线，从而添加混响和回声效果。实际的信号链路可能是复杂的连接网。

### 1.4 任意链路系统中的延迟补偿

当音频信号通过不同路径传输，最终合并时，必须保证这些信号在时间上对齐。即使只差一个音频采样，也会产生不想要的作用，如相位抵消和梳妆滤波。如图 3 所示，时间差越大，效果会更明显。

将一个信号与自身延迟 50 微秒（在 192 kHz 采样率下约为 10 采样）的信号合并，结果梳状滤波效应会在约 10 kHz 处使声音衰减。（这一延迟操作等同于将扬声器放到另一个播放相同声音的扬声器后 1.7 cm 处。）

对于纯模拟系统而言，这一点并无大碍。因为电信号传输速度为光速（或者说接近光速），比可闻频率要高得多。然而数字系统中，信号的最小粒度是一个音频采样（例如，48 kSPS 下为 20 微秒）。通常，数字效果器都会引入延迟。例如，均衡器需要花 1-2 个音频采样进行响应；限幅器需要抢先读取信号，探测信号电平；计算 RMS 平均电平通常需要 5ms。大多数数字效果器都存在固定的延迟，会将这一延迟报告给运行效果插件的 DAW。

下面举例说明：使用多个麦克风录制吉他和人声，使用多个效果器处理录制的声音，这些效果器引入的延迟不尽相同，处理完毕后合并声音，用于回放。

为了避免可闻的异状，从信号源途径不同链路到达重点的信号必须对齐。为了规避这一问题，很多基于硬件的方案会限制链路的方式，或是只允许将效果器加入总体音频信号链的特定总线。对于硬件踏板效果器而言，效果链通常也是固定的，不提供链路功能。为了降低链路的复杂度，很多 DAW 的辅助发送/返送效果通道数是有限的，大多数 DAW 不允许输出单个通道或总线，只有一个输入点和输出点。

在专业的后期处理系统中，将音频与外部时间码（如视频）对齐会添加一层复杂性。基本上同步点有三处：
- 对齐轨道：对齐单个轨道，或轨道类型（MIDI、音频）输出。提供灵活的信号链路，但可能会使总延迟变大。
- 对齐编组或总线：只对齐合并后的总线。
- 主控输出：所有信号都与主输出这一目标对齐。

还有一种方式，就是进行连接时使用所有上述同步点，并进行按需回归（regress）。这种变式（variant）便是此论文的主题：允许进行灵活的任意流向的信号链路，包括单独的轨道输出，同时总体延迟尽可能少地引入。

### 1.5 现状

如今针对这一问题，大多数专业工具要么通过厂商专有的硬件解决，要么通过限制用户的链路选项解决。方式和利弊因厂商和实现而异。

绝大多数情况下，延迟补偿会简化为插件延迟补偿（plugin delay compensation，简称为 PDC），这种方式只用于轨道的回放。例如，“补偿算法会为每个轨道引入需要的偏移”，忽略发送和返送链路，“不补偿返送轨道”。这一点和 Ardour 3 使用的方式没有差异。

另一款产品要求线形链路，采用了更严格的限制：“自动 PDC 不适用于多输出的插件”。

至少有一家厂商只为高端和专业产品系列提供 PDC 支持，并且启用需要用户手动操作。

要对齐音频输入，通常建议录制时使用较小的缓冲区大小，或者使用厂商专供的硬件。

很多 DAW 都会限制效果器插入点的位置（只支持推子后），此外其他软件没有总线之类的概念。用户手册中的信息通常布局散乱，网络论坛上常常讨论这一话题，并提供手动添加延迟处理的变通方案。

一大部分非专业的，“专业消费级”应用完全不进行延迟补偿。

## 2 研究与开发工作
### 2.1 选题背景、目的和 Ardour 历史简述

此研究的目的是为 Ardour DAW 实现专业的延迟补偿以及相关特性，使 Ardour 更加胜任专业制作和后期处理。

Ardour 的一个主要概念是提供任意流向的链路支持，这一特性由 JACK 音频连接套件引入，用于跨应用链路，在其他 DAW 中并不常见。

Ardour 由 Paul Davis 在 1999 年立项为一款硬盘录音软件，使用自由软件许可。软件的源码可以访问，其使用的 GPL 许可证提供的自由性使其成为了研究的理想候选。

Ardour 5（以及更早的版本）支持基本的音频轨道对齐，适用于录制和回放，但没有考虑辅助发送，实时输入延迟以及总线延迟。这一点引来了 2005 年（Ardour 0.99）的 bug report，以及添加延迟补偿功能的请求。

Ardour 2 专注一般的音频工作流，这一不足引来了大量让软件可用于传统的音频工程之外请求。特别是笔者关注电影配乐和相关工作流。

Ardour 3 于 2009 年开始开发，2013 年发布，添加了许多新特性。虽然最重要的莫过于 MIDI 轨道，但 3.0 版的变化是巨大的：这次更新的大部分内容（如并行 DSP 处理）对用户不可见。其他功能，如矩阵形跳线和链路，重做的导出系统，独立的监听区以及与外部时间码同步的方式使其向专业后期处理的场合迈进了一步。

当时，作者对时间码的 clock-chasing 算法贡献了大量内容，实现了视频时间轴支持的基础架构，根据已有标准重做了信号电平的测量。Ardour 3.5 满足了电影配乐制作的很多条件，发布时已经用于长片和大量短片的录制、剪辑和混音。

虽然特性的快速开发促成了 Ardour 3 的发布，但仍然缺少正确的延迟补偿特性。

尽管 Ardour 3 开发的一大部分内容并不简单，很多复杂的机制都基于讨论和基本的开发计划进行实现，但明显的是，正确的延迟补偿并不能如此完成。因为此软件开发的主要方式是推行单个封闭模块或组件的开发。

然而延迟补偿需要对整个软件的多个主要区域作更改：
- 音频引擎后端（输入/输出）
- 走带同步（绘画走带、外部时间码以及变速）
- 音频和 MIDI 轨道（先读、后写、缓冲区和缓存）
- 效果器插件的延迟接口
- 信号链路、侧脸以及对整个链路系统的修改
- 处理执行图

每一部分自身都是个繁杂的模块，模块间的交互就更加复杂了。在原型设计期间，开发者清晰地意识到，延迟补偿地正确实现需要大范围的计划工作，因此促成了此论文。

### 2.2 原型设计

2013-2014 年，正值软件 3.x 后期的开发周期，当时为将总线、效果器和 MIDI 合成器的延迟集成至 DAW 处理图中开发了一份原型。这一原型主要用作实验的演练场，以及可行性研究，并确定需要新增的构成要素与需要重新设计的组件。

此机制需要分析（信号）数据流图，从而得出引入延迟组最少的方案。所有信号均与一个共有的参考时刻，即全局走带控制（或播放游标）对齐。互不依赖的信号路径可以并行处理，原子性处置。然而，即使信号路径完全独立，也需要进行时间对齐，因此用处理图计算延迟只起一部分作用。

将独立的信号路径对齐，通过为路径较短的信号引入延迟，使其延迟时长变为总体最差延迟。然而，如果其中有信号不是实时输入，而是从硬盘读取并回放，则可以使读指针偏移，并应用先读机制。与输入的音频与预先录好的轨道对齐不同的是，先读机制使总体系统延迟更低。

要计算延迟图，对于图中的所有点（音频接口），必须回答下面的两个问题：  
- 从音频接口读取到的数据到达图的边缘过了多久？（捕获）
- 写入音频接口的数据到达图的边缘需要多久？（回放）

根据信号链路，这些问题的答案可能不只一个，当多个延迟不同的接口相连时，每个方向都可以确定一个最小和最大延迟。

如图 4 所示，总体延迟时系统延迟与内部延迟的结合，要保证绝对对齐，还需要工具量化外部延迟。在处理图之外，如果使用了多个设备，则每个设备的系统延迟可能不同。驱动程序和配置中捕获和回放的缓冲区设置不同也并非罕有。

信号的链路用有向无环图表示，对此图拓扑排序之后进行双向遍历，从而计算捕获和回放延迟。最后根据选择的同步点，向图中添加延迟处理，从而使所有点的延迟相等。

我们为 Ardour 3 DAW 进行概念验证的原型设计，得到一套系统。这套系统既有系统硬件的延迟补偿，也有轨道和总线音频的延迟补偿，使用主控总线作为同步点。见图 7。

原型设计时得到的很多基本组件，如音频和 MIDI 延迟处理，都可以应用到最终实现中，不过设计这份原型的目的主要还是调查并确定要解决的问题。

经过最初的概念验证实现，之后便是很多前置内容的开发，以及为准备完全实现而进行的重新设计。Ardour 4 不再将 JACK 作为必备后端；这次重构的任务还包括将所有音频输入/输出和硬件延迟计算的功能抽象至专门的内置接口引擎中。Ardour 4.x 还包含一个用于测量与校准系统音频和 MIDI 延迟的内置工具。许多内部实现的组件也是在 4.x 的开发周期中更新，从而正确应用时间对齐的操作。

我们在原型设计期间完成了很多外部工具和实用部件，其中一些在附录中描述。最显著的新增内容便是添加了允许观测以及直接访问内部的脚本。结果这一内容在对极端情况进行调试和修复时派上了大用场。

应用延迟补偿，将轨道硬盘 I/O 独立作专门的处理例程是一步主要过程，这一任务在 Ardour 5 开发后期进行。

到了 2017 年 Ardour 5 后期，全图延迟补偿的实现以及总体集成工作才开始进行。

包含 MIDI 轨道和通用数据（如自动化）以及多个同步点的完整系统将于第四章详述，撰文时 Git 主分支即将发行的 Ardour 6 以及包含了这一系统。

### 2.3 自由软件与合作开发

Ardour 使用 GNU 通用公共许可证，在 17 年的历史中吸引了许多开发者。可以在此处[29]浏览完整的开发人员列表（笔者的用户名 x42 也包含在列表中）。

此论文提到的概念中，有很多都是 Ardour 的原作者 Paul Davis 与身为主要开发者以及 2012 年起 Ardour 开发动力的笔者讨论而成的。

虽然 Paul 先前完成了稳固的结构抽象，然而近几年随着这一论文的编写工作，Ardour 也经历了大型的重构与重新设计。原作者原先开发的内容包括了切换到“仅处理”设计的方式，在论文后面的内容描述了这一点。这一工作的驱动因素在于提供经过延迟补偿的处理自动化，以及正确对齐的循环播放。结果我们实现了处理链中的插件针脚连接，以及带延迟补偿的侧链机制。另一项主要的重新设计工作则是一套从引擎层面支持变速的全新方式。

许多的额外内容开发并非停留在概念层面，而需要正确详述的实现。接口、辅助发送和插入的概念都是所有模拟调音台共有的传统内容。这些东西的基本结构 Ardour 之前就有，然而撰文期间修改了许多实现细节，尤其是接口和控制的所有权问题。

同样，接口引擎也有以 JACK 音频连接套件为形式的先前技术，不过语义稍有不同，尤其是对于更新接口延迟的同步与异步回调。作者也参与了指定 JACK 中扩展的延迟 API 的先前工作。

Ardour 是一个庞大且复杂的项目。但是，很多内容都是独立的，开发过程可以做到正交进行。不同部分通常是独立开发的，如控制面板、会话导出和插件 API 支持工作。

突出的 Ardour 主要贡献者还包括：David Robillard（drobilla），在两次 Google Summer of Code 赞助中设计与实现了 Ardour 的 MIDI 支持，也掌管 LV2 插件标准；Tim Mayberry（mojofunk）进行了将 Ardour 移植到 Windows 操作系统的初期工作，以及图形界面的改善；Nick Mainsbridge（nmains）负责速度映射、时间标尺、音乐时间相关的其他相关内容，以及波形渲染的优化。